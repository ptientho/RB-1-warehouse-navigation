<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4"
      main_tree_to_execute="MainTree">
  <BehaviorTree ID="MainTree">
    <Sequence>
      <Fallback>
        <CheckShelfAttached name="check_attach_shelf"
                            shelf_attached="{is_attached}"/>
        <Sequence>
          <SubTree ID="ShelfDetection" front_shelf="{front_shelf}" shelf_found="{shelf_found}"/>
          <SubTree ID="ShelfApproach"
                   front_shelf="{front_shelf}"
                   shelf_found="{shelf_found}"
                   is_attached="{is_attached}"/>
        </Sequence>
      </Fallback>
      <Delay delay_msec="3000">
      <RetryUntilSuccessful num_attempts="2">
        <AsyncSequence>
            <Repeat num_cycles="3">
                <BackUp/>
            </Repeat>
            <GoToDes goal_degree="90" action_name="__default__placeholder__"/>   
        </AsyncSequence>
      </RetryUntilSuccessful>
      </Delay>
      <DetachShelf detach_shelf="true"
                   is_success="{!is_attached}"
                   service_name="__default__placeholder__"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="ShelfApproach">
    <AsyncSequence>
      <CheckShelfFound shelf_found="{shelf_found}"/>
      <GoToPose2 pose="{front_shelf}"
                 action_name="__default__placeholder__"/>
      <Repeat num_cycles="1">
        <Sequence>
            <ShelfDetector front_offset="15.0"
                            shelf_pose="{front_shelf}"
                            find_shelf="{shelf_found}"
                            service_name="__default__placeholder__"/>
            <AttachShelf attach_shelf="false"
                        front_distance="0.2"
                        is_success="{is_attached}"
                        service_name="__default__placeholder__"/>
            <ShelfDetector front_offset="0.0"
                            shelf_pose="{front_shelf}"
                            find_shelf="{shelf_found}"
                            service_name="__default__placeholder__"/>
        </Sequence>
      </Repeat>
      <AttachShelf attach_shelf="true"
                   front_distance="0.0"
                   is_success="{is_attached}"
                   service_name="__default__placeholder__"/>
    </AsyncSequence>
  </BehaviorTree>

  <BehaviorTree ID="ShelfDetection">
    <AsyncFallback>
      <ShelfDetector front_offset="22.0"
                     shelf_pose="{front_shelf}"
                     find_shelf="{shelf_found}"
                     service_name="__default__placeholder__"/>
      <Sequence>
        <GoToPose loc="location1"
                  action_name="__default__placeholder__"/>
        <ShelfDetector front_offset="22.0"
                       shelf_pose="{front_shelf}"
                       find_shelf="{shelf_found}"
                       service_name="__default__placeholder__"/>
      </Sequence>
      <Sequence>
        <GoToPose loc="location2"
                  action_name="__default__placeholder__"/>
        <ShelfDetector front_offset="22.0"
                       shelf_pose="{front_shelf}"
                       find_shelf="{shelf_found}"
                       service_name="__default__placeholder__"/>
      </Sequence>
      <Sequence>
        <GoToPose loc="location3"
                  action_name="__default__placeholder__"/>
        <ShelfDetector front_offset="22.0"
                       shelf_pose="{front_shelf}"
                       find_shelf="{shelf_found}"
                       service_name="__default__placeholder__"/>
      </Sequence>
      <Sequence>
        <GoToPose loc="location4"
                  action_name="__default__placeholder__"/>
        <ShelfDetector front_offset="22.0"
                       shelf_pose="{front_shelf}"
                       find_shelf="{shelf_found}"
                       service_name="__default__placeholder__"/>
      </Sequence>
      <Sequence>
        <GoToPose loc="location5"
                  action_name="__default__placeholder__"/>
        <ShelfDetector front_offset="22.0"
                       shelf_pose="{front_shelf}"
                       find_shelf="{shelf_found}"
                       service_name="__default__placeholder__"/>
      </Sequence>
    </AsyncFallback>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Action ID="AttachShelf">
      <input_port name="attach_shelf"
                  type="bool"/>
      <input_port name="front_distance"
                  type="bool"/>
      <output_port name="is_success"
                   type="bool"/>
      <input_port name="service_name"
                  default="__default__placeholder__"
                  type="std::string">Service name</input_port>
    </Action>
    <Action ID="BackUp"/>
    <Condition ID="CheckShelfAttached">
      <input_port name="shelf_attached"
                  type="bool"/>
    </Condition>
    <Condition ID="CheckShelfFound">
      <input_port name="shelf_found"
                  type="bool"/>
    </Condition>
    <Action ID="DetachShelf">
      <input_port name="detach_shelf"
                  type="bool"/>
      <output_port name="is_success"
                   type="bool"/>
      <input_port name="service_name"
                  default="__default__placeholder__"
                  type="std::string">Service name</input_port>
    </Action>
    <Action ID="GoToPose">
      <input_port name="loc"
                  type="std::string"/>
      <input_port name="action_name"
                  default="__default__placeholder__"
                  type="std::string">Action server name</input_port>
    </Action>
    <Action ID="GoToPose2">
      <input_port name="pose"
                  type="geometry_msgs::msg::PoseStamped_&lt;std::allocator&lt;void&gt; &gt;"/>
      <input_port name="action_name"
                  default="__default__placeholder__"
                  type="std::string">Action server name</input_port>
    </Action>
    <Action ID="ShelfDetector">
      <input_port name="front_offset"
                  type="float"/>
      <output_port name="shelf_pose"
                   type="geometry_msgs::msg::PoseStamped_&lt;std::allocator&lt;void&gt; &gt;"/>
      <output_port name="find_shelf"
                   type="bool"/>
      <input_port name="service_name"
                  default="__default__placeholder__"
                  type="std::string">Service name</input_port>
    </Action>
  </TreeNodesModel>

</root>
