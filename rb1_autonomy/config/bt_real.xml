<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4"
      main_tree_to_execute="MainTree">
  <BehaviorTree ID="MainTree">
    <Sequence>
      <Fallback>
        <CheckShelfAttached name="check_attach_shelf"
                            shelf_attached="is_attached_real"/>
        <Sequence>
        <RetryUntilSuccessful num_attempts="5">
          <SubTree ID="ShelfDetection"
                   shelf_found="{shelf_found}"
                   front_shelf="{front_shelf}"/>
               </RetryUntilSuccessful>    
          <SubTree ID="ShelfApproach"
                   is_attached="{is_attached}"
                   front_shelf="{front_shelf}"
                   shelf_found="{shelf_found}"/>
        </Sequence>
      </Fallback>
      <Fallback>
        <!--GoToPose loc="desired_location_real"
                  action_name="__default__placeholder__"/-->
        <GoToDes goal_degree="156.5"/>
        <AsyncSequence>
          <Repeat num_cycles="3">
                <BackUp/>
            </Repeat>
          <!--GoToPose loc="desired_location_real"
                    action_name="__default__placeholder__"/-->
         <GoToDes goal_degree="156.5"/>
        </AsyncSequence>
      </Fallback>
      <DetachShelf detach_shelf="true"
                   shelf_attached="is_attached_real"
                   service_name="__default__placeholder__"/>
        <Repeat num_cycles="1">
            <BackUp/>
        </Repeat>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="ShelfApproach">
    <Sequence>
      <CheckShelfFound shelf_found="{shelf_found}"/>
      <GoToPose2 pose="{front_shelf}"
                 action_name="__default__placeholder__"/>
      <AttachShelf attach_shelf="true"
                   front_distance="0.05"
                   shelf_attached="is_attached_real"
                   service_name="__default__placeholder__"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="ShelfDetection">
    <Fallback>
      <ShelfDetectorReal shelf_pose="{front_shelf}"
                         find_shelf="{shelf_found}"
                         service_name="__default__placeholder__"/>
      <Sequence>
        <GoToPose loc="location1_real"
                  action_name="__default__placeholder__"/>
        <ShelfDetectorReal shelf_pose="{front_shelf}"
                           find_shelf="{shelf_found}"
                           service_name="__default__placeholder__"/>
      </Sequence>
      <Sequence>
        <GoToPose loc="location2_real"
                  action_name="__default__placeholder__"/>
        <ShelfDetectorReal shelf_pose="{front_shelf}"
                           find_shelf="{shelf_found}"
                           service_name="__default__placeholder__"/>
      </Sequence>
      <Sequence>
        <GoToPose loc="location3_real"
                  action_name="__default__placeholder__"/>
        <ShelfDetectorReal shelf_pose="{front_shelf}"
                           find_shelf="{shelf_found}"
                           service_name="__default__placeholder__"/>
      </Sequence>
      <Sequence>
        <GoToPose loc="location4_real"
                  action_name="__default__placeholder__"/>
        <ShelfDetectorReal shelf_pose="{front_shelf}"
                           find_shelf="{shelf_found}"
                           service_name="__default__placeholder__"/>
      </Sequence>
      <Sequence>
        <GoToPose loc="location5_real"
                  action_name="__default__placeholder__"/>
        <ShelfDetectorReal shelf_pose="{front_shelf}"
                           find_shelf="{shelf_found}"
                           service_name="__default__placeholder__"/>
      </Sequence>
      <Sequence>
        <GoToPose loc="location6_real"
                  action_name="__default__placeholder__"/>
        <ShelfDetectorReal shelf_pose="{front_shelf}"
                           find_shelf="{shelf_found}"
                           service_name="__default__placeholder__"/>
      </Sequence>
      <Sequence>
        <GoToPose loc="location7_real"
                  action_name="__default__placeholder__"/>
        <ShelfDetectorReal shelf_pose="{front_shelf}"
                           find_shelf="{shelf_found}"
                           service_name="__default__placeholder__"/>
      </Sequence>
      <Sequence>
        <GoToPose loc="location8_real"
                  action_name="__default__placeholder__"/>
        <ShelfDetectorReal shelf_pose="{front_shelf}"
                           find_shelf="{shelf_found}"
                           service_name="__default__placeholder__"/>
      </Sequence>
    </Fallback>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Action ID="AttachShelf">
      <input_port name="attach_shelf"
                  type="bool"/>
      <input_port name="front_distance"
                  type="bool"/>
      <output_port name="shelf_attached"
                   type="std::string"/>
      <input_port name="service_name"
                  default="__default__placeholder__"
                  type="std::string">Service name</input_port>
    </Action>
    <Action ID="BackUp"/>
    <Condition ID="CheckShelfAttached">
      <input_port name="shelf_attached"
                  type="std::string"/>
    </Condition>
    <Condition ID="CheckShelfFound">
      <input_port name="shelf_found"
                  type="bool"/>
    </Condition>
    <Action ID="DetachShelf">
      <input_port name="detach_shelf"
                  type="bool"/>
      <output_port name="shelf_attached"
                   type="std::string"/>
      <input_port name="service_name"
                  default="__default__placeholder__"
                  type="std::string">Service name</input_port>
    </Action>
    <Action ID="GoToPose">
      <input_port name="loc"
                  type="std::string"/>
      <input_port name="action_name"
                  default="__default__placeholder__"
                  type="std::string">Action server name</input_port>
    </Action>
    <Action ID="GoToPose2">
      <input_port name="pose"
                  type="geometry_msgs::msg::PoseStamped_&lt;std::allocator&lt;void&gt; &gt;"/>
      <input_port name="action_name"
                  default="__default__placeholder__"
                  type="std::string">Action server name</input_port>
    </Action>
    <Action ID="ShelfDetectorReal">
      <output_port name="shelf_pose"
                   type="geometry_msgs::msg::PoseStamped_&lt;std::allocator&lt;void&gt; &gt;"/>
      <output_port name="find_shelf"
                   type="bool"/>
      <input_port name="service_name"
                  default="__default__placeholder__"
                  type="std::string">Service name</input_port>
    </Action>
  </TreeNodesModel>

</root>
